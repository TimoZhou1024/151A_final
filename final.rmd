---
title: "Studying the Association Between Sleep and Depression Outcomes"
author: "Tianyun Jiang, Siyuan Zhou, Ethan Hardcastle"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Introduction

This analysis examines the association between sleep and depression outcomes among U.S. adults using NHANES 2017-2020 ("Pre-Pandemic") data. We investigate how sleep duration and sleep trouble (snoring, gasping, diagnosed sleep disorders) relate to depressive symptom severity (PHQ-9 total score), after adjusting for demographics, lifestyle factors, and medical interventions.

# Data Loading and Preparation

```{r load-packages}
# Load required packages
library(tidyverse)
library(car)       # For VIF and diagnostic tests
library(lmtest)    # For Breusch-Pagan test
library(MASS)      # For robust regression
library(broom)     # For tidy model outputs
library(gridExtra) # For arranging plots
```

```{r load-data}
# Load the processed dataset
data <- read.csv("dataset2_processed_zero.csv")

# Display basic information
cat("Dataset dimensions:", nrow(data), "rows,", ncol(data), "columns\n")
```

```{r create-response}
# Create PHQ-9 total score (sum of 9 depression items, each scored 0-3)
# Items: DPQ010-DPQ090 correspond to 9 depression screening questions
phq9_items <- c("Little_interest_or_pleasure_in_doing_things",
                "Feeling_down_depressed_or_hopeless",
                "Trouble_sleeping_or_sleeping_too_much",
                "Feeling_tired_or_having_little_energy",
                "Poor_appetite_or_overeating",
                "Feeling_bad_about_yourself_or_failure",
                "Trouble_concentrating",
                "Moving_speaking_slowly_or_being_fidgety_restless",
                "Thoughts_of_being_better_off_dead_self_harm")

# Calculate PHQ-9 total score
data$PHQ9_total <- rowSums(data[, phq9_items], na.rm = FALSE)

# Summary of PHQ-9 scores
cat("\nPHQ-9 Total Score Summary:\n")
summary(data$PHQ9_total)
```

```{r create-sleep-variables}
# Create average sleep duration (combining weekday and weekend sleep)
data$Avg_sleep_hours <- (data$Hours_of_sleep_on_weekdays_workdays +
                          data$Hours_of_sleep_on_weekends_non_workdays) / 2

# Create binary insomnia indicator (ever told by doctor about trouble sleeping)
# Coding: 1 = Yes, 2 = No, so we convert to binary (1 = Yes insomnia, 0 = No)
data$Insomnia <- ifelse(data$Ever_told_by_a_doctor_professional_you_had_trouble_sleeping == 1, 1, 0)

# Create sleep apnea indicator based on snoring and gasping frequency
# Higher values indicate more frequent symptoms (0 = never, higher = more frequent)
# We create binary: 1 if frequent snoring OR frequent gasping
data$Sleep_apnea <- ifelse(data$How_often_do_you_snore >= 3 |
                            data$How_often_snort_gasp_or_stop_breathing_during_sleep >= 3, 1, 0)

cat("Sleep Variables Created:\n")
cat("Average Sleep Hours Summary:\n")
summary(data$Avg_sleep_hours)
cat("\nInsomnia prevalence:", mean(data$Insomnia, na.rm = TRUE) * 100, "%\n")
cat("Sleep Apnea prevalence:", mean(data$Sleep_apnea, na.rm = TRUE) * 100, "%\n")
```

```{r prepare-covariates}
# Prepare demographic covariates
# Sex: 1 = Male, 2 = Female -> convert to factor
data$Sex <- factor(data$Sex, levels = c(1, 2), labels = c("Male", "Female"))

# Race/Hispanic origin: convert to factor
data$Race <- factor(data$Race_Hispanic_origin)

# Age is continuous
# Family income-to-poverty ratio is continuous

# Physical fitness proxy: BMI
# Note: We'll also use Weight as an alternative measure

cat("\nDemographic Variables Summary:\n")
cat("Sex distribution:\n")
table(data$Sex)
cat("\nAge summary:\n")
summary(data$Age_in_years_at_screening)
cat("\nFamily Income-to-Poverty Ratio summary:\n")
summary(data$Family_income_to_poverty_ratio)
```

```{r filter-valid-data}
# Filter to adults (18+) with valid PHQ-9 scores and sleep data
# Also exclude rows where key sleep variables have NA indicators = 1
data_analysis <- data
# data_analysis <- data %>%
#   filter(Age_in_years_at_screening >= 18,
#          !is.na(PHQ9_total),
#          !is.na(Avg_sleep_hours),
#          Hours_of_sleep_on_weekdays_workdays_NA_indicator == 0,
#          Hours_of_sleep_on_weekends_non_workdays_NA_indicator == 0)

cat("Analysis sample size:", nrow(data_analysis), "\n")
cat("Age range:", min(data_analysis$Age_in_years_at_screening), "-",
    max(data_analysis$Age_in_years_at_screening), "\n")
```

# Stage 1: Base Model

In Stage 1, we use the PHQ-9 total score as the response variable. The main regressors are:

- **Average sleep duration** (average of weekday and weekend sleep hours)
- **Insomnia** (binary: ever told by doctor about trouble sleeping)
- **Sleep apnea indicators** (binary: frequent snoring or gasping)

Covariates include gender, race, age, family income-to-poverty ratio, and BMI (as a proxy for physical fitness).

## Exploratory Data Analysis

```{r eda-phq9, fig.width=10, fig.height=4}
# Distribution of PHQ-9 scores
par(mfrow = c(1, 2))

hist(data_analysis$PHQ9_total,
     breaks = 28,
     main = "Distribution of PHQ-9 Total Score",
     xlab = "PHQ-9 Total Score (0-27)",
     col = "steelblue",
     border = "white")

# Sleep duration distribution
hist(data_analysis$Avg_sleep_hours,
     breaks = 20,
     main = "Distribution of Average Sleep Hours",
     xlab = "Average Sleep Hours",
     col = "darkgreen",
     border = "white")
```

```{r eda-bivariate, fig.width=10, fig.height=5}
# Bivariate relationships
par(mfrow = c(1, 2))

# Sleep duration vs PHQ-9 with LOESS
plot(data_analysis$Avg_sleep_hours, data_analysis$PHQ9_total,
     pch = 16, col = rgb(0, 0, 0, 0.1),
     xlab = "Average Sleep Hours",
     ylab = "PHQ-9 Total Score",
     main = "Sleep Duration vs Depression Severity")
loess_fit <- loess(PHQ9_total ~ Avg_sleep_hours, data = data_analysis)
sleep_seq <- seq(min(data_analysis$Avg_sleep_hours, na.rm = TRUE),
                 max(data_analysis$Avg_sleep_hours, na.rm = TRUE),
                 length.out = 100)
lines(sleep_seq, predict(loess_fit, data.frame(Avg_sleep_hours = sleep_seq)),
      col = "red", lwd = 2)

# Boxplot by insomnia status
boxplot(PHQ9_total ~ Insomnia, data = data_analysis,
        names = c("No Insomnia", "Insomnia"),
        xlab = "Insomnia Status",
        ylab = "PHQ-9 Total Score",
        main = "PHQ-9 by Insomnia Status",
        col = c("lightblue", "salmon"))
```

```{r eda-correlation}
# Correlation matrix for continuous predictors
continuous_vars <- c("PHQ9_total", "Avg_sleep_hours", "Age_in_years_at_screening",
                     "Family_income_to_poverty_ratio", "Body_mass_index")
cor_matrix <- cor(data_analysis[, continuous_vars], use = "complete.obs")
cat("Correlation Matrix:\n")
round(cor_matrix, 3)
```

## Base Model Fitting

```{r base-model}
# Fit the base model
# Response: PHQ-9 total score
# Main regressors: Average sleep hours, Insomnia, Sleep apnea
# Covariates: Sex, Race, Age, Income-to-poverty ratio, BMI

model_base <- lm(PHQ9_total ~ Avg_sleep_hours + Insomnia + Sleep_apnea +
                   Sex + Race + Age_in_years_at_screening +
                   Family_income_to_poverty_ratio + Body_mass_index,
                 data = data_analysis)

cat("=== Base Model Summary ===\n\n")
summary(model_base)
```

## NLM Assumption Checking

### Linearity and Homoscedasticity

```{r assumption-residuals, fig.width=10, fig.height=5}
par(mfrow = c(1, 2))

# Residuals vs Fitted plot
plot(model_base, which = 1, main = "Residuals vs Fitted")

# Scale-Location plot
plot(model_base, which = 3, main = "Scale-Location")
```

```{r bp-test}
# Breusch-Pagan test for heteroscedasticity
bp_test <- bptest(model_base)
cat("Breusch-Pagan Test for Heteroscedasticity:\n")
print(bp_test)

if (bp_test$p.value < 0.05) {
  cat("\nConclusion: Evidence of heteroscedasticity (p < 0.05).\n")
  cat("We will use heteroscedasticity-robust standard errors.\n")
} else {
  cat("\nConclusion: No strong evidence of heteroscedasticity.\n")
}
```

### Normality of Residuals

```{r assumption-normality, fig.width=10, fig.height=5}
par(mfrow = c(1, 2))

# Q-Q plot
plot(model_base, which = 2, main = "Normal Q-Q Plot")

# Histogram of residuals
hist(residuals(model_base),
     breaks = 50,
     main = "Distribution of Residuals",
     xlab = "Residuals",
     col = "steelblue",
     border = "white",
     freq = FALSE)
curve(dnorm(x, mean = 0, sd = sd(residuals(model_base))),
      add = TRUE, col = "red", lwd = 2)
```

```{r shapiro-test}
# Shapiro-Wilk test (on a sample due to size limitations)
set.seed(151)
sample_residuals <- sample(residuals(model_base), min(5000, length(residuals(model_base))))
shapiro_test <- shapiro.test(sample_residuals)
cat("Shapiro-Wilk Test for Normality (sample of residuals):\n")
print(shapiro_test)
```

### Multicollinearity Check

```{r vif-check}
# Variance Inflation Factors
vif_values <- vif(model_base)
cat("Variance Inflation Factors:\n")
print(vif_values)

max_vif <- max(vif_values[!is.nan(vif_values)])
if (max_vif > 5) {
  cat("\nWarning: Some VIF values > 5, indicating potential multicollinearity.\n")
} else {
  cat("\nAll VIF values < 5, no serious multicollinearity detected.\n")
}
```

## Addressing Non-Normality

Given that PHQ-9 scores are count data (0-27) with a right-skewed distribution, we consider transformations and alternative approaches.

```{r log-transformation}
# Try log transformation of response (adding 1 to handle zeros)
data_analysis$PHQ9_log <- log(data_analysis$PHQ9_total + 1)

model_base_log <- lm(PHQ9_log ~ Avg_sleep_hours + Insomnia + Sleep_apnea +
                       Sex + Race + Age_in_years_at_screening +
                       Family_income_to_poverty_ratio + Body_mass_index,
                     data = data_analysis)

cat("=== Base Model with Log-Transformed Response ===\n\n")
summary(model_base_log)
```

```{r log-diagnostics, fig.width=10, fig.height=5}
par(mfrow = c(1, 2))
plot(model_base_log, which = 1, main = "Residuals vs Fitted (Log Model)")
plot(model_base_log, which = 2, main = "Q-Q Plot (Log Model)")
```

## Robust Standard Errors

```{r robust-se}
# Calculate heteroscedasticity-robust standard errors
library(sandwich)
robust_se <- sqrt(diag(vcovHC(model_base, type = "HC1")))

cat("=== Comparison of Standard Errors ===\n\n")
comparison <- data.frame(
  Coefficient = names(coef(model_base)),
  Estimate = coef(model_base),
  OLS_SE = summary(model_base)$coefficients[, 2],
  Robust_SE = robust_se
)
print(comparison, digits = 4)
```

## Base Model Interpretation

```{r base-interpretation}
cat("=== Key Findings from Base Model ===\n\n")

# Extract coefficients for main sleep variables
coefs <- summary(model_base)$coefficients

cat("Sleep Variables Effects on PHQ-9 Score:\n\n")

cat("1. Average Sleep Hours:\n")
cat("   Coefficient:", round(coefs["Avg_sleep_hours", "Estimate"], 4), "\n")
cat("   p-value:", format(coefs["Avg_sleep_hours", "Pr(>|t|)"], scientific = TRUE), "\n")
if (coefs["Avg_sleep_hours", "Pr(>|t|)"] < 0.05) {
  if (coefs["Avg_sleep_hours", "Estimate"] < 0) {
    cat("   Interpretation: More sleep is associated with LOWER depression scores.\n\n")
  } else {
    cat("   Interpretation: More sleep is associated with HIGHER depression scores.\n\n")
  }
}

cat("2. Insomnia (diagnosed trouble sleeping):\n")
cat("   Coefficient:", round(coefs["Insomnia", "Estimate"], 4), "\n")
cat("   p-value:", format(coefs["Insomnia", "Pr(>|t|)"], scientific = TRUE), "\n")
if (coefs["Insomnia", "Pr(>|t|)"] < 0.05) {
  cat("   Interpretation: Having diagnosed insomnia is associated with",
      round(coefs["Insomnia", "Estimate"], 2), "point increase in PHQ-9.\n\n")
}

cat("3. Sleep Apnea (frequent snoring/gasping):\n")
cat("   Coefficient:", round(coefs["Sleep_apnea", "Estimate"], 4), "\n")
cat("   p-value:", format(coefs["Sleep_apnea", "Pr(>|t|)"], scientific = TRUE), "\n")

cat("\nModel R-squared:", round(summary(model_base)$r.squared, 4), "\n")
cat("Adjusted R-squared:", round(summary(model_base)$adj.r.squared, 4), "\n")
```

## Outlier and Influential Point Detection (Stage 1)

```{r outlier-detection-s1, fig.width=10, fig.height=5}
par(mfrow = c(1, 2))

# Cook's Distance
plot(model_base, which = 4, main = "Cook's Distance")

# Residuals vs Leverage
plot(model_base, which = 5, main = "Residuals vs Leverage")
```

```{r influential-points-s1}
# Identify influential points
cooks_d <- cooks.distance(model_base)
influential_threshold <- 4 / nrow(data_analysis)

influential_points <- which(cooks_d > influential_threshold)
cat("Number of potentially influential points (Cook's D >",
    round(influential_threshold, 5), "):", length(influential_points), "\n")
cat("Percentage:", round(length(influential_points) / nrow(data_analysis) * 100, 2), "%\n")

# High leverage points
leverage <- hatvalues(model_base)
p <- length(coef(model_base))
n <- nrow(data_analysis)
high_leverage <- which(leverage > 2 * p / n)
cat("\nNumber of high leverage points:", length(high_leverage), "\n")
```

# Stage 2: Adding Lifestyle Covariates

In Stage 2, we expand the base model by adding lifestyle variables:

- Work activity intensity (vigorous and moderate)
- Recreational activity intensity
- Transportation mode (walk/bicycle)
- Secondhand smoke exposure

```{r stage2-model}
# Fit model with lifestyle covariates
model_lifestyle <- lm(PHQ9_total ~ Avg_sleep_hours + Insomnia + Sleep_apnea +
                        Sex + Race + Age_in_years_at_screening +
                        Family_income_to_poverty_ratio + Body_mass_index +
                        # Lifestyle covariates
                        Work_vigorous_intensity_activity +
                        Work_moderate_intensity_activity +
                        Transport_walk_or_bicycle +
                        Recreation_vigorous_intensity_activity +
                        Secondhand_smoke_exposure_at_home,
                      data = data_analysis)

cat("=== Stage 2: Model with Lifestyle Covariates ===\n\n")
summary(model_lifestyle)
```

```{r model-comparison-s2}
# Compare models using ANOVA
cat("=== Model Comparison: Base vs Lifestyle ===\n\n")
anova_test <- anova(model_base, model_lifestyle)
print(anova_test)

if (anova_test$`Pr(>F)`[2] < 0.05) {
  cat("\nConclusion: Lifestyle covariates significantly improve model fit (p < 0.05).\n")
} else {
  cat("\nConclusion: Lifestyle covariates do not significantly improve model fit.\n")
}
```

## Interaction Effects: Lifestyle × Sleep Variables

We systematically test all 15 possible interactions between the 3 sleep variables and 5 lifestyle variables. Each interaction is added to the base lifestyle model one at a time.

```{r interaction-lifestyle-sleep-systematic}
cat("=== Systematic Testing of All 15 Lifestyle × Sleep Interactions ===\n\n")

# Define sleep variables
sleep_vars <- c("Avg_sleep_hours", "Insomnia", "Sleep_apnea")
sleep_labels <- c("Average Sleep Hours", "Insomnia", "Sleep Apnea")

# Define lifestyle variables
lifestyle_vars <- c("Work_vigorous_intensity_activity",
                    "Work_moderate_intensity_activity",
                    "Transport_walk_or_bicycle",
                    "Recreation_vigorous_intensity_activity",
                    "Secondhand_smoke_exposure_at_home")
lifestyle_labels <- c("Work Vigorous Activity",
                      "Work Moderate Activity",
                      "Active Transport",
                      "Recreation Vigorous Activity",
                      "Secondhand Smoke Exposure")

# Store results
interaction_results <- data.frame(
  Sleep_Variable = character(),
  Lifestyle_Variable = character(),
  Interaction_Coef = numeric(),
  Std_Error = numeric(),
  t_value = numeric(),
  p_value = numeric(),
  Significant = character(),
  stringsAsFactors = FALSE
)

# Test each interaction one by one
for (i in 1:length(sleep_vars)) {
  for (j in 1:length(lifestyle_vars)) {

    sleep_var <- sleep_vars[i]
    lifestyle_var <- lifestyle_vars[j]

    # Create formula with one interaction term
    # Build formula dynamically
    base_formula <- "PHQ9_total ~ Avg_sleep_hours + Insomnia + Sleep_apnea +
                     Sex + Race + Age_in_years_at_screening +
                     Family_income_to_poverty_ratio + Body_mass_index +
                     Work_vigorous_intensity_activity +
                     Work_moderate_intensity_activity +
                     Transport_walk_or_bicycle +
                     Recreation_vigorous_intensity_activity +
                     Secondhand_smoke_exposure_at_home"

    interaction_term <- paste(sleep_var, "*", lifestyle_var)
    formula_str <- paste(base_formula, "+", interaction_term)

    # Fit model
    model_interact <- lm(as.formula(formula_str), data = data_analysis)

    # Extract interaction coefficient
    coef_summary <- summary(model_interact)$coefficients
    interaction_row_name <- paste0(sleep_var, ":", lifestyle_var)

    # Check if interaction term exists in output
    if (interaction_row_name %in% rownames(coef_summary)) {
      coef_est <- coef_summary[interaction_row_name, "Estimate"]
      std_err <- coef_summary[interaction_row_name, "Std. Error"]
      t_val <- coef_summary[interaction_row_name, "t value"]
      p_val <- coef_summary[interaction_row_name, "Pr(>|t|)"]

      sig_label <- ifelse(p_val < 0.001, "***",
                          ifelse(p_val < 0.01, "**",
                                 ifelse(p_val < 0.05, "*",
                                        ifelse(p_val < 0.1, ".", "NS"))))

      # Add to results
      interaction_results <- rbind(interaction_results,
                                   data.frame(
                                     Sleep_Variable = sleep_labels[i],
                                     Lifestyle_Variable = lifestyle_labels[j],
                                     Interaction_Coef = coef_est,
                                     Std_Error = std_err,
                                     t_value = t_val,
                                     p_value = p_val,
                                     Significant = sig_label,
                                     stringsAsFactors = FALSE
                                   ))
    }
  }
}

# Display results
cat("\n=== Summary of All 15 Interaction Tests ===\n\n")
cat("Each interaction was tested by adding it to the base lifestyle model.\n")
cat("Significance codes: *** p<0.001, ** p<0.01, * p<0.05, . p<0.1, NS not significant\n\n")

print(interaction_results, row.names = FALSE, digits = 4)

# Identify significant interactions
significant_interactions <- interaction_results[interaction_results$p_value < 0.05, ]

cat("\n\n=== Significant Interactions (p < 0.05) ===\n\n")
if (nrow(significant_interactions) > 0) {
  print(significant_interactions, row.names = FALSE, digits = 4)
  cat("\n", nrow(significant_interactions), "out of 15 interactions are statistically significant.\n")
} else {
  cat("No interactions are statistically significant at the 0.05 level.\n")
}

# Marginally significant interactions
marginal_interactions <- interaction_results[interaction_results$p_value >= 0.05 &
                                              interaction_results$p_value < 0.1, ]
cat("\n\n=== Marginally Significant Interactions (0.05 ≤ p < 0.1) ===\n\n")
if (nrow(marginal_interactions) > 0) {
  print(marginal_interactions, row.names = FALSE, digits = 4)
} else {
  cat("No marginally significant interactions.\n")
}
```

## Detailed Examination of Significant Interactions

```{r examine-significant-interactions}
# For significant interactions, provide detailed output

if (nrow(significant_interactions) > 0) {

  cat("\n=== Detailed Models for Significant Interactions ===\n\n")

  for (k in 1:nrow(significant_interactions)) {

    sleep_var_label <- significant_interactions$Sleep_Variable[k]
    lifestyle_var_label <- significant_interactions$Lifestyle_Variable[k]

    # Map back to variable names
    sleep_var <- sleep_vars[which(sleep_labels == sleep_var_label)]
    lifestyle_var <- lifestyle_vars[which(lifestyle_labels == lifestyle_var_label)]

    cat("\n", rep("=", 70), "\n", sep = "")
    cat("Interaction:", sleep_var_label, "×", lifestyle_var_label, "\n")
    cat(rep("=", 70), "\n\n", sep = "")

    # Refit the model
    base_formula <- "PHQ9_total ~ Avg_sleep_hours + Insomnia + Sleep_apnea +
                     Sex + Race + Age_in_years_at_screening +
                     Family_income_to_poverty_ratio + Body_mass_index +
                     Work_vigorous_intensity_activity +
                     Work_moderate_intensity_activity +
                     Transport_walk_or_bicycle +
                     Recreation_vigorous_intensity_activity +
                     Secondhand_smoke_exposure_at_home"

    interaction_term <- paste(sleep_var, "*", lifestyle_var)
    formula_str <- paste(base_formula, "+", interaction_term)

    model_interact_detail <- lm(as.formula(formula_str), data = data_analysis)

    # Show coefficient table for main effects and interaction
    coef_table <- summary(model_interact_detail)$coefficients
    relevant_rows <- c(sleep_var, lifestyle_var, paste0(sleep_var, ":", lifestyle_var))
    relevant_rows <- relevant_rows[relevant_rows %in% rownames(coef_table)]

    cat("Coefficients:\n")
    print(coef_table[relevant_rows, , drop = FALSE])

    cat("\n")
  }

} else {
  cat("\n=== No Significant Interactions to Detail ===\n")
}
```

## Visualization of Interaction Effects

```{r visualize-interactions, fig.width=12, fig.height=8}
# Visualize significant interactions

if (nrow(significant_interactions) > 0) {

  # Determine layout
  n_sig <- nrow(significant_interactions)
  n_cols <- min(3, n_sig)
  n_rows <- ceiling(n_sig / n_cols)

  par(mfrow = c(n_rows, n_cols), mar = c(4, 4, 3, 1))

  for (k in 1:n_sig) {

    sleep_var_label <- significant_interactions$Sleep_Variable[k]
    lifestyle_var_label <- significant_interactions$Lifestyle_Variable[k]

    sleep_var <- sleep_vars[which(sleep_labels == sleep_var_label)]
    lifestyle_var <- lifestyle_vars[which(lifestyle_labels == lifestyle_var_label)]

    # Create interaction plot
    # Split lifestyle variable into low/high groups
    lifestyle_median <- median(data_analysis[[lifestyle_var]], na.rm = TRUE)
    data_analysis$lifestyle_group <- ifelse(data_analysis[[lifestyle_var]] <= lifestyle_median,
                                             "Low", "High")

    # For binary variables, use actual levels
    if (length(unique(data_analysis[[lifestyle_var]])) <= 3) {
      data_analysis$lifestyle_group <- factor(data_analysis[[lifestyle_var]])
    }

    # Fit model with interaction
    base_formula <- "PHQ9_total ~ Avg_sleep_hours + Insomnia + Sleep_apnea +
                     Sex + Race + Age_in_years_at_screening +
                     Family_income_to_poverty_ratio + Body_mass_index +
                     Work_vigorous_intensity_activity +
                     Work_moderate_intensity_activity +
                     Transport_walk_or_bicycle +
                     Recreation_vigorous_intensity_activity +
                     Secondhand_smoke_exposure_at_home"

    interaction_term <- paste(sleep_var, "*", lifestyle_var)
    formula_str <- paste(base_formula, "+", interaction_term)
    model_temp <- lm(as.formula(formula_str), data = data_analysis)

    # Create prediction data - handle binary vs continuous variables
    sleep_unique <- unique(data_analysis[[sleep_var]][!is.na(data_analysis[[sleep_var]])])

    # If sleep variable is binary or has few levels, use actual levels; otherwise create range
    if (length(sleep_unique) <= 3) {
      sleep_range <- sort(sleep_unique)
    } else {
      sleep_range <- seq(min(data_analysis[[sleep_var]], na.rm = TRUE),
                         max(data_analysis[[sleep_var]], na.rm = TRUE),
                         length.out = 50)
    }

    # Plot
    plot(data_analysis[[sleep_var]], data_analysis$PHQ9_total,
         pch = 16, col = rgb(0, 0, 0, 0.05),
         xlab = sleep_var_label,
         ylab = "PHQ-9 Total Score",
         main = paste(sleep_var_label, "×", lifestyle_var_label))

    # Add regression lines for different levels of lifestyle variable
    lifestyle_levels <- unique(data_analysis[[lifestyle_var]])
    lifestyle_levels <- lifestyle_levels[!is.na(lifestyle_levels)]

    if (length(lifestyle_levels) <= 5) {
      colors <- rainbow(length(lifestyle_levels))
      for (m in 1:length(lifestyle_levels)) {

        # Create base data frame with mean values
        new_data <- data.frame(
          Avg_sleep_hours = mean(data_analysis$Avg_sleep_hours, na.rm = TRUE),
          Insomnia = mean(data_analysis$Insomnia, na.rm = TRUE),
          Sleep_apnea = mean(data_analysis$Sleep_apnea, na.rm = TRUE),
          Sex = names(sort(table(data_analysis$Sex), decreasing = TRUE))[1],
          Race = names(sort(table(data_analysis$Race), decreasing = TRUE))[1],
          Age_in_years_at_screening = mean(data_analysis$Age_in_years_at_screening, na.rm = TRUE),
          Family_income_to_poverty_ratio = mean(data_analysis$Family_income_to_poverty_ratio, na.rm = TRUE),
          Body_mass_index = mean(data_analysis$Body_mass_index, na.rm = TRUE),
          Work_vigorous_intensity_activity = mean(data_analysis$Work_vigorous_intensity_activity, na.rm = TRUE),
          Work_moderate_intensity_activity = mean(data_analysis$Work_moderate_intensity_activity, na.rm = TRUE),
          Transport_walk_or_bicycle = mean(data_analysis$Transport_walk_or_bicycle, na.rm = TRUE),
          Recreation_vigorous_intensity_activity = mean(data_analysis$Recreation_vigorous_intensity_activity, na.rm = TRUE),
          Secondhand_smoke_exposure_at_home = mean(data_analysis$Secondhand_smoke_exposure_at_home, na.rm = TRUE)
        )

        # Replicate for each sleep_range value
        new_data <- new_data[rep(1, length(sleep_range)), ]

        # Set the sleep variable to the range
        new_data[[sleep_var]] <- sleep_range

        # Set the lifestyle variable to current level
        new_data[[lifestyle_var]] <- lifestyle_levels[m]

        pred <- predict(model_temp, newdata = new_data)
        lines(sleep_range, pred, col = colors[m], lwd = 2)
      }

      legend("topright",
             legend = paste(lifestyle_var_label, "=", lifestyle_levels),
             col = colors, lwd = 2, cex = 0.7, bg = "white")
    }
  }

} else {
  cat("No significant interactions to visualize.\n")
}
```

## Stage 2 Diagnostics

```{r diagnostics-s2, fig.width=10, fig.height=5}
par(mfrow = c(1, 2))
plot(model_lifestyle, which = 1, main = "Residuals vs Fitted (Stage 2)")
plot(model_lifestyle, which = 2, main = "Q-Q Plot (Stage 2)")
```

```{r vif-s2}
cat("=== VIF for Stage 2 Model ===\n")
vif_s2 <- vif(model_lifestyle)
print(vif_s2)
```

```{r influential-s2, fig.width=10, fig.height=5}
par(mfrow = c(1, 2))
plot(model_lifestyle, which = 4, main = "Cook's Distance (Stage 2)")
plot(model_lifestyle, which = 5, main = "Residuals vs Leverage (Stage 2)")

cooks_d_s2 <- cooks.distance(model_lifestyle)
influential_s2 <- which(cooks_d_s2 > influential_threshold)
cat("\nInfluential points in Stage 2 model:", length(influential_s2), "\n")
```

# Stage 3: Adding Medical Intervention Covariates

In Stage 3, we add variables tracking medical interventions:

- Whether taking prescription medicines
- Number of prescription medicines
- Whether seen/talked to a mental health professional

```{r stage3-model}
# Fit model with medical intervention covariates
model_medical <- lm(PHQ9_total ~ Avg_sleep_hours + Insomnia + Sleep_apnea +
                      Sex + Race + Age_in_years_at_screening +
                      Family_income_to_poverty_ratio + Body_mass_index +
                      # Lifestyle covariates
                      Work_vigorous_intensity_activity +
                      Work_moderate_intensity_activity +
                      Transport_walk_or_bicycle +
                      Recreation_vigorous_intensity_activity +
                      Secondhand_smoke_exposure_at_home +
                      # Medical intervention covariates
                      Took_any_prescription_medicine +
                      Number_of_prescription_medicines +
                      Seen_talked_to_a_mental_health_professional,
                    data = data_analysis)

cat("=== Stage 3: Model with Medical Intervention Covariates ===\n\n")
summary(model_medical)
```

```{r model-comparison-s3}
# Compare models
cat("=== Model Comparison: Lifestyle vs Medical ===\n\n")
anova_test_s3 <- anova(model_lifestyle, model_medical)
print(anova_test_s3)

if (anova_test_s3$`Pr(>F)`[2] < 0.05) {
  cat("\nConclusion: Medical intervention covariates significantly improve model fit.\n")
}
```

## Interaction Effects: Medical Intervention × Sleep Variables

We systematically test all 9 possible interactions between the 3 sleep variables and 3 medical intervention variables. Each interaction is added to the base medical model one at a time.

Note: We test interactions with binary medical intervention variables (Took_any_prescription_medicine, Seen_talked_to_a_mental_health_professional) and exclude Number_of_prescription_medicines from interactions as it's highly correlated with Took_any_prescription_medicine.

```{r interaction-medical-sleep-systematic}
cat("=== Systematic Testing of All 9 Medical × Sleep Interactions ===\n\n")

# Define sleep variables (same as Stage 2)
sleep_vars <- c("Avg_sleep_hours", "Insomnia", "Sleep_apnea")
sleep_labels <- c("Average Sleep Hours", "Insomnia", "Sleep Apnea")

# Define medical intervention variables
medical_vars <- c("Took_any_prescription_medicine",
                  "Seen_talked_to_a_mental_health_professional",
                  "Number_of_prescription_medicines")
medical_labels <- c("Taking Prescription Medicine",
                    "Mental Health Professional",
                    "Number of Prescriptions")

# Store results
interaction_results_s3 <- data.frame(
  Sleep_Variable = character(),
  Medical_Variable = character(),
  Interaction_Coef = numeric(),
  Std_Error = numeric(),
  t_value = numeric(),
  p_value = numeric(),
  Significant = character(),
  stringsAsFactors = FALSE
)

# Test each interaction one by one
for (i in 1:length(sleep_vars)) {
  for (j in 1:length(medical_vars)) {

    sleep_var <- sleep_vars[i]
    medical_var <- medical_vars[j]

    # Create formula with one interaction term
    base_formula <- "PHQ9_total ~ Avg_sleep_hours + Insomnia + Sleep_apnea +
                     Sex + Race + Age_in_years_at_screening +
                     Family_income_to_poverty_ratio + Body_mass_index +
                     Work_vigorous_intensity_activity +
                     Work_moderate_intensity_activity +
                     Transport_walk_or_bicycle +
                     Recreation_vigorous_intensity_activity +
                     Secondhand_smoke_exposure_at_home +
                     Took_any_prescription_medicine +
                     Number_of_prescription_medicines +
                     Seen_talked_to_a_mental_health_professional"

    interaction_term <- paste(sleep_var, "*", medical_var)
    formula_str <- paste(base_formula, "+", interaction_term)

    # Fit model
    model_interact <- lm(as.formula(formula_str), data = data_analysis)

    # Extract interaction coefficient
    coef_summary <- summary(model_interact)$coefficients
    interaction_row_name <- paste0(sleep_var, ":", medical_var)

    # Check if interaction term exists in output
    if (interaction_row_name %in% rownames(coef_summary)) {
      coef_est <- coef_summary[interaction_row_name, "Estimate"]
      std_err <- coef_summary[interaction_row_name, "Std. Error"]
      t_val <- coef_summary[interaction_row_name, "t value"]
      p_val <- coef_summary[interaction_row_name, "Pr(>|t|)"]

      sig_label <- ifelse(p_val < 0.001, "***",
                          ifelse(p_val < 0.01, "**",
                                 ifelse(p_val < 0.05, "*",
                                        ifelse(p_val < 0.1, ".", "NS"))))

      # Add to results
      interaction_results_s3 <- rbind(interaction_results_s3,
                                      data.frame(
                                        Sleep_Variable = sleep_labels[i],
                                        Medical_Variable = medical_labels[j],
                                        Interaction_Coef = coef_est,
                                        Std_Error = std_err,
                                        t_value = t_val,
                                        p_value = p_val,
                                        Significant = sig_label,
                                        stringsAsFactors = FALSE
                                      ))
    }
  }
}

# Display results
cat("\n=== Summary of All 9 Interaction Tests ===\n\n")
cat("Each interaction was tested by adding it to the base medical model.\n")
cat("Significance codes: *** p<0.001, ** p<0.01, * p<0.05, . p<0.1, NS not significant\n\n")

print(interaction_results_s3, row.names = FALSE, digits = 4)

# Identify significant interactions
significant_interactions_s3 <- interaction_results_s3[interaction_results_s3$p_value < 0.05, ]

cat("\n\n=== Significant Interactions (p < 0.05) ===\n\n")
if (nrow(significant_interactions_s3) > 0) {
  print(significant_interactions_s3, row.names = FALSE, digits = 4)
  cat("\n", nrow(significant_interactions_s3), "out of 9 interactions are statistically significant.\n")
} else {
  cat("No interactions are statistically significant at the 0.05 level.\n")
}

# Marginally significant interactions
marginal_interactions_s3 <- interaction_results_s3[interaction_results_s3$p_value >= 0.05 &
                                                    interaction_results_s3$p_value < 0.1, ]
cat("\n\n=== Marginally Significant Interactions (0.05 ≤ p < 0.1) ===\n\n")
if (nrow(marginal_interactions_s3) > 0) {
  print(marginal_interactions_s3, row.names = FALSE, digits = 4)
} else {
  cat("No marginally significant interactions.\n")
}
```

## Detailed Examination of Significant Interactions (Stage 3)

```{r examine-significant-interactions-s3}
# For significant interactions, provide detailed output

if (nrow(significant_interactions_s3) > 0) {

  cat("\n=== Detailed Models for Significant Medical × Sleep Interactions ===\n\n")

  for (k in 1:nrow(significant_interactions_s3)) {

    sleep_var_label <- significant_interactions_s3$Sleep_Variable[k]
    medical_var_label <- significant_interactions_s3$Medical_Variable[k]

    # Map back to variable names
    sleep_var <- sleep_vars[which(sleep_labels == sleep_var_label)]
    medical_var <- medical_vars[which(medical_labels == medical_var_label)]

    cat("\n", rep("=", 70), "\n", sep = "")
    cat("Interaction:", sleep_var_label, "×", medical_var_label, "\n")
    cat(rep("=", 70), "\n\n", sep = "")

    # Refit the model
    base_formula <- "PHQ9_total ~ Avg_sleep_hours + Insomnia + Sleep_apnea +
                     Sex + Race + Age_in_years_at_screening +
                     Family_income_to_poverty_ratio + Body_mass_index +
                     Work_vigorous_intensity_activity +
                     Work_moderate_intensity_activity +
                     Transport_walk_or_bicycle +
                     Recreation_vigorous_intensity_activity +
                     Secondhand_smoke_exposure_at_home +
                     Took_any_prescription_medicine +
                     Number_of_prescription_medicines +
                     Seen_talked_to_a_mental_health_professional"

    interaction_term <- paste(sleep_var, "*", medical_var)
    formula_str <- paste(base_formula, "+", interaction_term)

    model_interact_detail <- lm(as.formula(formula_str), data = data_analysis)

    # Show coefficient table for main effects and interaction
    coef_table <- summary(model_interact_detail)$coefficients
    relevant_rows <- c(sleep_var, medical_var, paste0(sleep_var, ":", medical_var))
    relevant_rows <- relevant_rows[relevant_rows %in% rownames(coef_table)]

    cat("Coefficients:\n")
    print(coef_table[relevant_rows, , drop = FALSE])

    cat("\n")
  }

} else {
  cat("\n=== No Significant Medical × Sleep Interactions to Detail ===\n")
}
```

## Visualization of Medical Interaction Effects

```{r visualize-medical-interactions, fig.width=12, fig.height=8}
# Visualize significant medical interactions

if (nrow(significant_interactions_s3) > 0) {

  # Determine layout
  n_sig <- nrow(significant_interactions_s3)
  n_cols <- min(3, n_sig)
  n_rows <- ceiling(n_sig / n_cols)

  par(mfrow = c(n_rows, n_cols), mar = c(4, 4, 3, 1))

  for (k in 1:n_sig) {

    sleep_var_label <- significant_interactions_s3$Sleep_Variable[k]
    medical_var_label <- significant_interactions_s3$Medical_Variable[k]

    sleep_var <- sleep_vars[which(sleep_labels == sleep_var_label)]
    medical_var <- medical_vars[which(medical_labels == medical_var_label)]

    # Fit model with interaction
    base_formula <- "PHQ9_total ~ Avg_sleep_hours + Insomnia + Sleep_apnea +
                     Sex + Race + Age_in_years_at_screening +
                     Family_income_to_poverty_ratio + Body_mass_index +
                     Work_vigorous_intensity_activity +
                     Work_moderate_intensity_activity +
                     Transport_walk_or_bicycle +
                     Recreation_vigorous_intensity_activity +
                     Secondhand_smoke_exposure_at_home +
                     Took_any_prescription_medicine +
                     Number_of_prescription_medicines +
                     Seen_talked_to_a_mental_health_professional"

    interaction_term <- paste(sleep_var, "*", medical_var)
    formula_str <- paste(base_formula, "+", interaction_term)
    model_temp <- lm(as.formula(formula_str), data = data_analysis)

    # Create prediction data - handle binary vs continuous variables
    sleep_unique <- unique(data_analysis[[sleep_var]][!is.na(data_analysis[[sleep_var]])])

    # If sleep variable is binary or has few levels, use actual levels; otherwise create range
    if (length(sleep_unique) <= 3) {
      sleep_range <- sort(sleep_unique)
    } else {
      sleep_range <- seq(min(data_analysis[[sleep_var]], na.rm = TRUE),
                         max(data_analysis[[sleep_var]], na.rm = TRUE),
                         length.out = 50)
    }

    # Plot
    plot(data_analysis[[sleep_var]], data_analysis$PHQ9_total,
         pch = 16, col = rgb(0, 0, 0, 0.05),
         xlab = sleep_var_label,
         ylab = "PHQ-9 Total Score",
         main = paste(sleep_var_label, "×", medical_var_label))

    # Add regression lines for different levels of medical variable
    medical_levels <- unique(data_analysis[[medical_var]])
    medical_levels <- medical_levels[!is.na(medical_levels)]

    # For binary or low-cardinality variables
    if (length(medical_levels) <= 5) {
      colors <- c("blue", "red", "green", "orange", "purple")[1:length(medical_levels)]

      for (m in 1:length(medical_levels)) {

        # Create base data frame with mean values
        new_data <- data.frame(
          Avg_sleep_hours = mean(data_analysis$Avg_sleep_hours, na.rm = TRUE),
          Insomnia = mean(data_analysis$Insomnia, na.rm = TRUE),
          Sleep_apnea = mean(data_analysis$Sleep_apnea, na.rm = TRUE),
          Sex = names(sort(table(data_analysis$Sex), decreasing = TRUE))[1],
          Race = names(sort(table(data_analysis$Race), decreasing = TRUE))[1],
          Age_in_years_at_screening = mean(data_analysis$Age_in_years_at_screening, na.rm = TRUE),
          Family_income_to_poverty_ratio = mean(data_analysis$Family_income_to_poverty_ratio, na.rm = TRUE),
          Body_mass_index = mean(data_analysis$Body_mass_index, na.rm = TRUE),
          Work_vigorous_intensity_activity = mean(data_analysis$Work_vigorous_intensity_activity, na.rm = TRUE),
          Work_moderate_intensity_activity = mean(data_analysis$Work_moderate_intensity_activity, na.rm = TRUE),
          Transport_walk_or_bicycle = mean(data_analysis$Transport_walk_or_bicycle, na.rm = TRUE),
          Recreation_vigorous_intensity_activity = mean(data_analysis$Recreation_vigorous_intensity_activity, na.rm = TRUE),
          Secondhand_smoke_exposure_at_home = mean(data_analysis$Secondhand_smoke_exposure_at_home, na.rm = TRUE),
          Took_any_prescription_medicine = mean(data_analysis$Took_any_prescription_medicine, na.rm = TRUE),
          Number_of_prescription_medicines = mean(data_analysis$Number_of_prescription_medicines, na.rm = TRUE),
          Seen_talked_to_a_mental_health_professional = mean(data_analysis$Seen_talked_to_a_mental_health_professional, na.rm = TRUE)
        )

        # Replicate for each sleep_range value
        new_data <- new_data[rep(1, length(sleep_range)), ]

        # Set the sleep variable to the range
        new_data[[sleep_var]] <- sleep_range

        # Set the medical variable to current level
        new_data[[medical_var]] <- medical_levels[m]

        pred <- predict(model_temp, newdata = new_data)
        lines(sleep_range, pred, col = colors[m], lwd = 2)
      }

      legend("topright",
             legend = paste(medical_var_label, "=", medical_levels),
             col = colors[1:length(medical_levels)], lwd = 2, cex = 0.7, bg = "white")
    }
  }

} else {
  cat("No significant medical interactions to visualize.\n")
}
```

## Stage 3 Diagnostics

```{r diagnostics-s3, fig.width=10, fig.height=5}
par(mfrow = c(1, 2))
plot(model_medical, which = 1, main = "Residuals vs Fitted (Stage 3)")
plot(model_medical, which = 2, main = "Q-Q Plot (Stage 3)")
```

```{r vif-s3}
cat("=== VIF for Stage 3 Model ===\n")
vif_s3 <- vif(model_medical)
print(vif_s3)
```

```{r influential-s3, fig.width=10, fig.height=5}
par(mfrow = c(1, 2))
plot(model_medical, which = 4, main = "Cook's Distance (Stage 3)")
plot(model_medical, which = 5, main = "Residuals vs Leverage (Stage 3)")

cooks_d_s3 <- cooks.distance(model_medical)
influential_s3 <- which(cooks_d_s3 > influential_threshold)
cat("\nInfluential points in Stage 3 model:", length(influential_s3), "\n")
```

## Robustness Check: Model Without Influential Points

```{r robust-model-s3}
# Remove highly influential points and refit
highly_influential <- which(cooks_d_s3 > 4 * influential_threshold)
cat("Removing", length(highly_influential), "highly influential points for robustness check.\n\n")

if (length(highly_influential) > 0) {
  data_robust <- data_analysis[-highly_influential, ]

  model_medical_robust <- lm(PHQ9_total ~ Avg_sleep_hours + Insomnia + Sleep_apnea +
                               Sex + Race + Age_in_years_at_screening +
                               Family_income_to_poverty_ratio + Body_mass_index +
                               Work_vigorous_intensity_activity +
                               Work_moderate_intensity_activity +
                               Transport_walk_or_bicycle +
                               Recreation_vigorous_intensity_activity +
                               Secondhand_smoke_exposure_at_home +
                               Took_any_prescription_medicine +
                               Number_of_prescription_medicines +
                               Seen_talked_to_a_mental_health_professional,
                             data = data_robust)

  cat("=== Coefficient Comparison: Original vs Robust ===\n\n")
  comparison_robust <- data.frame(
    Variable = names(coef(model_medical)),
    Original = coef(model_medical),
    Robust = coef(model_medical_robust),
    Pct_Change = round((coef(model_medical_robust) - coef(model_medical)) /
                         abs(coef(model_medical)) * 100, 2)
  )
  print(comparison_robust)
}
```

# Summary of Stages 1-3

```{r summary-table}
# Create summary comparison table
cat("=== Model Comparison Summary ===\n\n")

model_summary <- data.frame(
  Model = c("Stage 1: Base", "Stage 2: + Lifestyle", "Stage 3: + Medical"),
  R_squared = c(summary(model_base)$r.squared,
                summary(model_lifestyle)$r.squared,
                summary(model_medical)$r.squared),
  Adj_R_squared = c(summary(model_base)$adj.r.squared,
                    summary(model_lifestyle)$adj.r.squared,
                    summary(model_medical)$adj.r.squared),
  AIC = c(AIC(model_base), AIC(model_lifestyle), AIC(model_medical)),
  BIC = c(BIC(model_base), BIC(model_lifestyle), BIC(model_medical)),
  Residual_SE = c(summary(model_base)$sigma,
                  summary(model_lifestyle)$sigma,
                  summary(model_medical)$sigma)
)

print(model_summary, digits = 4)
```

```{r sleep-effects-summary}
# Summary of sleep variable effects across models
cat("\n=== Sleep Variable Effects Across Models ===\n\n")

extract_sleep_coefs <- function(model, name) {
  coefs <- summary(model)$coefficients
  data.frame(
    Model = name,
    Sleep_Hours_Coef = coefs["Avg_sleep_hours", "Estimate"],
    Sleep_Hours_p = coefs["Avg_sleep_hours", "Pr(>|t|)"],
    Insomnia_Coef = coefs["Insomnia", "Estimate"],
    Insomnia_p = coefs["Insomnia", "Pr(>|t|)"],
    Sleep_Apnea_Coef = coefs["Sleep_apnea", "Estimate"],
    Sleep_Apnea_p = coefs["Sleep_apnea", "Pr(>|t|)"]
  )
}

sleep_effects <- rbind(
  extract_sleep_coefs(model_base, "Stage 1"),
  extract_sleep_coefs(model_lifestyle, "Stage 2"),
  extract_sleep_coefs(model_medical, "Stage 3")
)

print(sleep_effects, digits = 4)
```
